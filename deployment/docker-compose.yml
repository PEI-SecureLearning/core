name: SecureLearning

services:
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "${NGINX_PORT}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      frontend:
        condition: service_healthy
      api:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      default:
        aliases:
          - kc.securelearning.pt
          - api.securelearning.pt
          - app.securelearning.pt

  db:
    build:
      context: ../db
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    expose:
      - "5432"
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 10s
      timeout: 5s
      retries: 10

  mongo:
    build:
      context: ../mongo
      dockerfile: Dockerfile
    container_name: mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DB}
    expose:
      - "27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: [ "CMD", "mongo", "--quiet", "-u", "${MONGO_ROOT_USER}", "-p", "${MONGO_ROOT_PASSWORD}", "--authenticationDatabase", "admin", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 10

  rabbitmq:
    build:
      context: ../rabbitmq
      dockerfile: Dockerfile
    container_name: rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
      RABBITMQ_API_USER: ${RABBITMQ_API_USER}
      RABBITMQ_API_PASS: ${RABBITMQ_API_PASS}
      RABBITMQ_SMTP_USER: ${RABBITMQ_SMTP_USER}
      RABBITMQ_SMTP_PASS: ${RABBITMQ_SMTP_PASS}
      RABBITMQ_QUEUE: ${RABBITMQ_QUEUE}
    expose:
      - "5672"
      - "15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 10

  smtp:
    build:
      context: ../smtp
      dockerfile: Dockerfile
    container_name: smtp
    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: ${RABBITMQ_SMTP_USER}
      RABBITMQ_PASS: ${RABBITMQ_SMTP_PASS}
      RABBITMQ_QUEUE: ${RABBITMQ_QUEUE}
      RATE_LIMITER_MAX_REQUESTS: ${RATE_LIMITER_MAX_REQUESTS}
      RATE_LIMITER_TIME_WINDOW_SECONDS: ${RATE_LIMITER_TIME_WINDOW_SECONDS}
      API_INTERNAL_URL: ${API_INTERNAL_URL}
      API_URL: ${API_URL}
    depends_on:
      rabbitmq:
        condition: service_healthy

  keycloak:
    build:
      context: ../keycloak
      dockerfile: Dockerfile
    command: start-dev --import-realm --proxy-headers=xforwarded
    container_name: keycloak
    restart: unless-stopped
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}

      KC_IMPORT: /opt/keycloak/data/import/
      KC_LOG_LEVEL: INFO
      KC_HTTP_ACCESS_LOG_ENABLED: "true"

      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://db:5432/keycloak
      KC_DB_USERNAME: ${POSTGRES_USER}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD}

      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_BACKCHANNEL_DYNAMIC: "true"
      KC_HOSTNAME: ${KEYCLOAK_URL}
      KC_HOSTNAME_STRICT: "false"

      KC_HEALTH_ENABLED: "true"

      CLIENT_SECRET: ${CLIENT_SECRET}
      WEB_URL: ${WEB_URL}
      API_URL: ${API_URL}
    healthcheck:
      test: [ "CMD-SHELL", "exec 3<>/dev/tcp/localhost/9000 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && timeout 1 cat <&3 | grep -q UP" ]
      interval: 30s
      timeout: 10s
      retries: 30
      start_period: 120s
    expose:
      - "8080"
      - "9000"
    depends_on:
      db:
        condition: service_healthy

  api:
    build:
      context: ../api
      dockerfile: Dockerfile
    container_name: api
    restart: unless-stopped
    environment:
      POSTGRES_SERVER: db
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      KEYCLOAK_URL: ${KEYCLOAK_INTERNAL_URL}
      CLIENT_SECRET: ${CLIENT_SECRET}
      MONGODB_URI: mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongo:27017/${MONGO_DB}?authSource=${MONGO_DB}
      MONGODB_DB: securelearning
      MONGODB_COLLECTION_TEMPLATES: templates
      WEB_URL: ${WEB_URL}
      API_URL: ${API_URL}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: ${RABBITMQ_API_USER}
      RABBITMQ_PASS: ${RABBITMQ_API_PASS}
      RABBITMQ_QUEUE: ${RABBITMQ_QUEUE}
    expose:
      - "80"
    healthcheck:
      test: [ "CMD", "wget", "-qO", "/dev/null", "http://localhost:80/health" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    depends_on:
      db:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      mongo:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  frontend:
    build:
      context: ../web
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${API_URL}
        VITE_KEYCLOAK_URL: ${KEYCLOAK_URL}
    container_name: frontend
    expose:
      - "80"
    healthcheck:
      test: [ "CMD", "wget", "-qO", "/dev/null", "http://localhost:80" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    depends_on:
      api:
        condition: service_healthy

networks:
  default:
    name: securelearning
    driver: bridge

volumes:
  db_data:
  rabbitmq_data:
  mongo_data:
